<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->

<html>
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <script src="lib/simpleRequire.js"></script>
        <script src="lib/config.js"></script>
        <script src="lib/jquery.min.js"></script>
        <script src="lib/facePrint.js"></script>
        <script src="lib/testHelper.js"></script>
        <!-- <script src="ut/lib/canteen.js"></script> -->
        <link rel="stylesheet" href="lib/reset.css" />
    </head>
    <body>
        <style></style>

        <div id="main"></div>

        <script>
            window.ANIMATION_DURATION_UPDATE = 1000;
        </script>

        <script>
            require(['echarts'], function (echarts) {
                var chart = testHelper.create(echarts, 'main', {
                    title: [
                        'Multiple levels of drilldown for bar charts',
                        '(1) 1 old series --> 1 new series each `setOption()`',
                        '(2) Get groupId from encode (by dimension)'
                    ],
                    height: 300
                });

                // level 1 (root)
                const data_1 = [
                    ['1_1', 5, '1', '1_1'],
                    ['1_2', 2, '1', '1_2']
                ];
                // level 2
                const data_1_1 = [
                    ['1_1_1', 2, '1_1', '1_1_1'],
                    ['1_1_2', 2, '1_1', '1_1_2'],
                    ['1_1_3', 3, '1_1', '1_1_3']
                ];
                const data_1_2 = [
                    ['1_2_1', 6, '1_2', '1_2_1'],
                    ['1_2_2', 7, '1_2', '1_2_2']
                ];
                // level 3
                const data_1_1_1 = [
                    ['1_1_1_A', 5, '1_1_1'], // the "childest" data need not to be specified a `childGroupId`
                    ['1_1_1_B', 6, '1_1_1'],
                    ['1_1_1_C', 7, '1_1_1'],
                    ['1_1_1_D', 8, '1_1_1']
                ];
                const data_1_1_2 = [
                    ['1_1_2_A', 2, '1_1_2'],
                    ['1_1_2_B', 9, '1_1_2']
                ];
                const data_1_1_3 = [
                    ['1_1_3_A', 1, '1_1_3'],
                    ['1_1_3_B', 2, '1_1_3'],
                    ['1_1_3_C', 8, '1_1_3']
                ];
                const data_1_2_1 = [
                    ['1_2_1_A', 9, '1_2_1'],
                    ['1_2_1_B', 2, '1_2_1'],
                    ['1_2_1_C', 1, '1_2_1']
                ];
                const data_1_2_2 = [
                    ['1_2_2_A', 7, '1_2_2'],
                    ['1_2_2_B', 7, '1_2_2']
                ];
                const allLevelData = [
                    data_1,
                    data_1_1,
                    data_1_2,
                    data_1_1_1,
                    data_1_1_2,
                    data_1_1_3,
                    data_1_2_1,
                    data_1_2_2
                ];

                const allOptions = {};

                allLevelData.forEach((data) => {
                    // since dataItems of each data have same groupId in this
                    // example, we can use groupId as optionId for optionStack.
                    const optionId = data[0][2];

                    const option = {
                        id: optionId, // option.id is not a property of echarts option model, but can be accessed if we provide it
                        xAxis: {
                            type: 'category'
                        },
                        yAxis: {},
                        animationDurationUpdate: 500,
                        series: {
                            type: 'bar',
                            dimensions: ['x', 'y', 'groupId', 'childGroupId'],
                            encode: {
                                x: 'x',
                                y: 'y',
                                itemGroupId: 'groupId',
                                childGroupId: 'childGroupId'
                            },
                            data,
                            universalTransition: {
                                enabled: true,
                                divideShape: 'clone'
                            }
                        },
                        graphic: [
                            {
                                type: 'text',
                                left: 50,
                                top: 20,
                                style: {
                                    text: 'Back',
                                    fontSize: 18
                                },
                                onclick: function () {
                                    goBack();
                                }
                            }
                        ]
                    };
                    allOptions[optionId] = option;
                });

                // A stack to remember previous option id
                const optionStack = [];

                const goForward = (optionId) => {
                    optionStack.push(chart.getOption().id); // push current option id into stack.
                    chart.setOption(allOptions[optionId], false);
                };

                const goBack = () => {
                    if (optionStack.length === 0) {
                        console.log('Already in root level!');
                    } else {
                        console.log('Go back to previous level');
                        chart.setOption(allOptions[optionStack.pop()]);
                    }
                };

                option = allOptions['1']; // The initial option is the root data option

                chart.on('click', 'series.bar', (params) => {
                    if (params.data[3]) {
                        // If current params is not belong to the "childest" data, it has data[3]
                        const childGroupId = params.data[3];
                        // since we use groupId as optionId in this example,
                        // we use childGroupId as the next level optionId.
                        const nextOptionId = childGroupId;
                        goForward(nextOptionId);
                    }
                });

                option && chart.setOption(option);

                window.onresize = chart.resize;
            });
        </script>
    </body>
</html>
